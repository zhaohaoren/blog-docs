# ThreadLocal ä½¿ç”¨åŠåŸç†

è¿™ç®—æ˜¯æ—¥å¸¸å¤„ç†å¹¶å‘é—®é¢˜ä¸­ï¼Œæ¯”è¾ƒå¸¸è§å’Œæ˜“ç”¨ä¸€ä¸ªæŠ€æœ¯ç‚¹äº†ã€‚æ— è®ºæ¡†æ¶ä¸­è¿˜æ˜¯å¹³æ—¶ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæœ‰æ—¶å€™å°±ç‰¹åˆ«é€‚åˆä½¿ç”¨ThreadLocalæ¥è§£å†³ä¸€äº›é—®é¢˜ã€‚

ThreadLocalï¼ˆåˆè¢«ç§°ä¸ºçº¿ç¨‹æœ¬åœ°å˜é‡ï¼‰ã€‚å­—é¢æ„æ€ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰æœ¬åœ°å˜é‡çš„å‰¯æœ¬ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´çš„å˜é‡äº’ä¸å¹²æ‰°ã€‚ç›¸å¯¹å¾ˆå¤šçº¿ç¨‹åŒæ­¥ä»£ç æ‰§è¡Œå—çš„æ–¹å¼ï¼ŒThreadLocalé‡‡ç”¨çš„åˆ™æ˜¯ç©ºé—´æ¢æ—¶é—´æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š**å¦‚æœæˆ‘ä»¬ä¿è¯æ¯ä¸ªçº¿ç¨‹è®¿é—®çš„éƒ½æ˜¯è‡ªå·±çš„å˜é‡ï¼ˆçº¿ç¨‹èµ„æºéš”ç¦»ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå­˜åœ¨å…±äº«çš„å¹¶å‘é—®é¢˜äº†**ã€‚æˆ‘ä»¬é€šè¿‡ThreadLocalç›¸å½“äºå¯ä»¥ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºè‡ªå·±çš„ç¼“å­˜ï¼Œä¹‹ååœ¨æœ¬çº¿ç¨‹ä¸­éœ€è¦çš„å˜é‡ï¼Œéƒ½ä»è¯¥ç¼“å­˜ä¸­è·å–å³å¯ã€‚

## ç®€å•ä½¿ç”¨

æºç ä¸­å°±æ³¨é‡Šäº†ä¸€æ®µdemoï¼š

```java
public class ThreadId {
    // Atomic integer containing the next thread ID to be assigned
    private static final AtomicInteger nextId = new AtomicInteger(0);
    // ä¸€èˆ¬åœ¨ä¸€ä¸ªç±»ä¸­éƒ½å®šä¹‰ä¸ºprivate staticéå†
    private static final ThreadLocal<Integer> threadId =
        new ThreadLocal<Integer>() {
            @Override protected Integer initialValue() {
                return nextId.getAndIncrement();
        }
    };
    // Returns the current thread's unique ID, assigning it if necessary
    public static int get() {
        return threadId.get();
    }
}
```

è¿™ä¸ªDemoå°±æ˜¯å¯¹æ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªè‡ªå¢idã€‚

- å½“æˆ‘ä»¬éœ€è¦éœ€è¦åœ¨è¿™ä¸ªçº¿ç¨‹åé¢ä½¿ç”¨æŸä¸ªå˜é‡å’Œå¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±é€šè¿‡å®šä¹‰çš„è¿™ä¸ªThreadLocalçš„`set`æ–¹æ³•ï¼Œå°†å€¼ä¿å­˜åœ¨å½“å‰çº¿ç¨‹æœ¬åœ°ï¼›
- å½“éœ€è¦ä½¿ç”¨çš„æ—¶å€™è°ƒç”¨`get`æ–¹æ³•è·å–ï¼›
- å¦‚æœç¡®å®šä¸å†ä½¿ç”¨äº†ï¼Œå†é€šè¿‡`remove`æ–¹æ³•ç§»é™¤ã€‚ã€è¿™æ˜¯å®¹æ˜“è¢«å¿½ç•¥ä½†æ˜¯åˆå¾ˆé‡è¦çš„æ­¥éª¤ã€‘

## åŸç†

### ä¸ºä»€ä¹ˆä½¿ç”¨ï¼Ÿ

**é¦–å…ˆæ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ThreadLocalï¼Ÿ**

è®¾å®šä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå·¨é•¿çš„ä¸šåŠ¡é€»è¾‘é“¾ï¼Œæ–¹æ³•A-B-C-D-E-F-....ã€‚ è¿™æ—¶å€™Aå¤„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡XXï¼Œç„¶åè¿™ä¸ªå¯¹è±¡éœ€è¦ç»™Bï¼Œç„¶åBè¦ç»™Cï¼ŒCè¦ç»™Dã€‚æˆ‘ä»¬å°±è¦åœ¨è¿™äº›æ–¹æ³•ä¸Šæ¯ä¸€ä¸ªéƒ½åŠ ä¸Šä¸€ä¸ªå‚æ•°XXã€‚ è¿™æ ·ä½ ä¸€å®šä¹Ÿè§‰å¾—å¾ˆçƒ¦ï¼ æ‰€ä»¥åœ¨å•çº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä¸€å®šæ˜¯å®šä¹‰äº†ä¸€ä¸ªå…¨å±€çš„å˜é‡XXï¼ŒAåˆ›å»ºå®Œèµ‹å€¼åï¼ŒBCDè¿™äº›éƒ½ç›´æ¥ä»XXä¸Šè·å–å°±å¥½äº†ã€‚

ä½†æ˜¯å¤šçº¿ç¨‹ä¸‹ï¼Œå°±å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜äº†ï¼Œ2ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹äº’ç›¸èµ‹å€¼å’Œè·å–ï¼Œåˆ°æ—¶å€™ç»“æœä¸€å®šä¼šæœ‰é—®é¢˜ã€‚

æ‰€ä»¥é—®é¢˜æ¥äº†ï¼š

1. æˆ‘æƒ³æ”¾åœ¨å…¨å±€ä¸Šï¼Œä¸è¦æ¯ä¸ªæ–¹æ³•ä¸Šéƒ½å¸¦ç€å‚æ•°ã€‚
2. æˆ‘åˆæƒ³è¿™ä¸ªåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯å®‰å…¨çš„ï¼Œè¿™è¯¥å’‹æ•´ï¼Ÿ

å¦‚æœæ²¡æœ‰ThreadLocalçš„è¯ï¼Œä½ å¤§å¯èƒ½ä¼šå°†XXå®šä¹‰æˆä¸€ä¸ªMapè¿™æ ·çš„ï¼Œç„¶åè¿™ä¸ªMapçš„keyå­˜æ”¾çº¿ç¨‹çš„IDï¼Œç„¶åå¾€è¿™ä¸ªMapé‡Œé¢å­˜æ•°æ®ï¼Œéœ€è¦çš„æ—¶å€™å†å–æ˜¯ä¸æ˜¯ï¼ˆå…¶å®ThreadLocalåŸç†åŸºæœ¬ä¹Ÿæ˜¯è¿™ä¸ªæ€æƒ³ï¼‰ï¼ŸJavaå¸®ä½ getåˆ°äº†è¿™ä¸ªéœ€æ±‚ï¼Œä¸ºä½ åˆ›å»ºäº†ThreadLocalçš„è¿™ä¸ªç±»ï¼ˆçœ‹ä¸‹é¢åŸç†å°±æ˜ç™½äº†è¿™æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼‰ï¼Œè¿™éƒ¨åˆ†å·¥ä½œä¸éœ€è¦ä½ æ¥å®Œæˆï¼ŒJDKå¸®ä½ åšã€‚



### é€‚ç”¨åœºæ™¯

ä¸€èˆ¬ä¸šåŠ¡å¼€å‘ä¸­ï¼Œä¸ªäººè®¤ä¸ºå­˜åœ¨2ç§å¾ˆé€‚ç”¨åœºæ™¯ï¼š

1. ä¸ºäº†ç‹¬äº«å¯¹è±¡å®‰å…¨æ›´æ–°ï¼šæ¯ä¸ªçº¿ç¨‹åˆ›å»ºè‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œç„¶ååç»­ä¸šåŠ¡æ“ä½œä¸­ä¿®æ”¹å‰¯æœ¬çš„å±æ€§å€¼ç­‰ï¼Œä¸ä¼šå½±å“å…¶ä»–çš„çº¿ç¨‹ã€‚
2. ä¸ºäº†ç‹¬äº«å¯¹è±¡å…¨å±€ä½¿ç”¨ï¼šåœ¨ä¸šåŠ¡é€»è¾‘çš„æŸä¸ªç‚¹å¤„ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¸Œæœ›åœ¨åé¢å¾ˆå¤šæ–¹æ³•ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯åˆä¸å¸Œæœ›é€šè¿‡æ–¹æ³•å‚æ•°åä¸€å±‚å±‚çš„å¾€ä¸‹ä¼ é€’ã€‚

æ³¨æ„ï¼šThreadLocalå¹¶ä¸æ˜¯æ»¡è¶³æ‰€æœ‰çš„å¹¶å‘åœºæ™¯ï¼Œä¸è¦æ»¥ç”¨å®ƒæ¥è§£å†³æ‰€æœ‰å¹¶å‘é—®é¢˜ã€‚

åˆ†åˆ«ä¸¾2ä¸ªåœºæ™¯çš„å…·ä½“ä¾‹å­ï¼š

**åœºæ™¯1ï¼š**

- åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¤šæ•°æ®æºçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡åå°„æ³¨è§£æ¥è·å–å½“å‰æ•°æ®æºåº”è¯¥åˆ‡åˆ°å“ªä¸ªæ•°æ®æºä¸Šã€‚è¿™æ—¶å€™å¯ä»¥å®šä¹‰ä¸€ä¸ªThreadLocal\<Queue\<String>>æ¥å­˜æ”¾å½“å‰çº¿ç¨‹ä¸‹æ•°æ®æºåˆ‡æ¢çš„é¡ºåºï¼šæ¯”å¦‚DataSourceA -> DataSourceB -> DataSourceC å½“Cä½¿ç”¨å®Œäº†ï¼Œå°±å¼¹å‡ºCï¼Œåé¢çš„é€»è¾‘ç»§ç»­ä½¿ç”¨Bæ•°æ®æºã€‚
- å¦‚æœä¸ä½¿ç”¨ThreadLocalçš„è¯ï¼Œé‚£ä¹ˆå°±å…¨ä¹±å¥—äº†ï¼Œåˆ«çš„çº¿ç¨‹åˆ‡äº†ä¼šå½±å“åˆ°å½“å‰çº¿ç¨‹çš„æ•°æ®æºåˆ¤æ–­ã€‚

**åœºæ™¯2ï¼š**

- è¿™ä¸ªåœºæ™¯æ˜¯ä½¿ç”¨æœ€å¤šçš„ï¼Œæ¯”å¦‚Javaä¸­SimpleDateFormatæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæˆ‘ä»¬æƒ³è¦ä½¿ç”¨ï¼Œå°±å¯ä»¥ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„SimpleDateFormatå¯¹è±¡ã€‚å†æ¯”å¦‚Springçš„äº‹åŠ¡ç®¡ç†ï¼Œä¼šåœ¨äº‹åŠ¡é€»è¾‘å‰ï¼Œå…ˆå°†ä¸€ä¸ªæ•°æ®åº“Connectionæ”¾å…¥åˆ°ThreadLocalä¸­ï¼Œåç»­çš„æ‰€æœ‰æ“ä½œéƒ½ä½¿ç”¨è¯¥Connectionã€‚
- è¿™ç±»åœºæ™¯å…¶å®ï¼Œæ›´å¤šçš„æ˜¯ä¸ºäº†ç”¨ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„å·¥å…·ç±»ï¼Œå¹¶ä¸ä¼šä¿®æ”¹å®ƒã€‚

å¯ä»¥çœ‹åˆ°ï¼ŒThreadLocalçš„é‡ç‚¹ä¸æ˜¯ä¸ºäº†å¯¹è±¡çš„**å…±äº«å®‰å…¨**ã€‚å¯¹äºè¿™ç±»çš„åœºæ™¯ThreadLocalæ˜¯å¸®ä¸ä¸Šä»€ä¹ˆå¿™çš„ã€‚æˆ‘ä»¬æœ‰äº›å¹¶å‘åœºæ™¯æ˜¯é€šè¿‡å…±äº«å¯¹è±¡æ¥åšçº¿ç¨‹ä¹‹é—´çš„äº¤äº’çš„ï¼ˆæ¯”å¦‚ç»Ÿè®¡ç½‘é¡µæ¥å£çš„è®¿é—®é‡ï¼Œéœ€è¦åªå¯¹ä¸€ä¸ªå…±äº«çš„å˜é‡è¿›è¡ŒåŠ 1ï¼‰ï¼Œè¿™ç§åœºæ™¯ä¸æ˜¯ThreadLocalæœåŠ¡çš„åœºæ™¯ã€‚ThreadLocalæœåŠ¡çš„ä¸€å®šæ˜¯**ç‹¬äº«å˜é‡**ã€‚

> ä¸ªäººè§‰å¾—ï¼Œä½¿ç”¨ThreadLocalç»™æˆ‘ä»¬å¸¦æ¥çš„éå†æ€§åœ¨äºï¼š**é¿å…æŸä¸ªå¯¹è±¡éœ€è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è°ƒç”¨çš„æ–¹æ³•é“¾ä¸Šè¿›è¡Œå·¨é•¿é“¾æ¡çš„ä¼ å‚é“¾ **ã€‚



### æºç åˆ†æ

æˆ‘ä»¬ä½¿ç”¨ThreadLocalçš„æ—¶å€™ä¸€èˆ¬å°±æ˜¯é‚£å‡ ä¸ªæ–¹æ³•ï¼Œè€Œè¿™å±è”½äº†åº•å±‚å…·ä½“å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å®ç°ç»†èŠ‚ã€‚å…¶å®ThreadLocalçš„æºç æ¯”è¾ƒç®€å•ï¼Œä¸»ä½“ç»“æ„å¦‚ä¸‹ï¼š

```java
public class ThreadLocal<T> {
    private final int threadLocalHashCode = nextHashCode();
    private static AtomicInteger nextHashCode =
        new AtomicInteger();
    private static final int HASH_INCREMENT = 0x61c88647;
  	// æ ¸å¿ƒæ–¹æ³•
    public ThreadLocal() {}
    public T get() {}
    public void set(T value) {}
    public void remove() {}
  	// æ ¸å¿ƒå†…éƒ¨ç±»
    static class ThreadLocalMap {
        static class Entry extends WeakReference<ThreadLocal<?>> {
            Object value;
            Entry(ThreadLocal<?> k, Object v) {
                super(k);
                value = v;
            }
        }
    }
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ThreadLocalä¸­åªæ˜¯æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œå’Œä¸€ä¸ªå†…éƒ¨ç±»ã€‚è€Œå®ƒæœ¬èº«æ˜¯ä¸å­˜æ”¾ä»»ä½•å¯¹è±¡çš„ã€‚æ‰€ä»¥å…³é”®ç‚¹å°±æ˜¯çœ‹æˆ‘ä»¬å¸¸ç”¨çš„getå’Œsetæ–¹æ³•ï¼š

#### setæ–¹æ³•

```java
public void set(T value) {
 //è·å–å½“å‰çº¿ç¨‹ï¼Œç„¶åè·å–åˆ°å½“å‰çº¿ç¨‹é‡Œé¢çš„ThreadLocalMapå¼•ç”¨ï¼Œ
 //åˆ¤æ–­å½“å‰çº¿ç¨‹é‡Œé¢æ˜¯åˆ›å»ºè¯¥Mapå¯¹è±¡ï¼Œæœ‰åˆ™ç›´æ¥setï¼Œæ²¡æœ‰å°±åˆå§‹åŒ–ä¸€ä¸ªMap,å†å°†å€¼æ”¾å…¥ã€‚
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);// ä»¥ThreadLocalå¯¹è±¡ä¸ºkey ä¼ å…¥valueä¸ºvalue
    else
        createMap(t, value);
}
```

åªæ˜¯é€šè¿‡`Thread.currentThread()`æ‹¿åˆ°å½“å‰çš„çº¿ç¨‹å¯¹è±¡ï¼Œç„¶åé€šè¿‡getMapè·å–äº†ä¸€ä¸ª`ThreadLocalMap`å¯¹è±¡ï¼Œè€Œvalueæ˜¯æ”¾åœ¨è¿™ä¸ªmapä¸­çš„ã€‚æˆ‘ä»¬çœ‹çœ‹getMapåšäº†å•¥ï¼Ÿ

```java
ThreadLocalMap getMap(Thread t) {
    // åªæ˜¯è¿”å›äº†Threadçš„ä¸€ä¸ªå±æ€§å€¼
    return t.threadLocals;
}
```

getMapçš„ä½œç”¨å…¶å®å°±æ˜¯è·å–Threadçº¿ç¨‹ä¸­çš„å±æ€§å€¼ï¼š`ThreadLocal.ThreadLocalMap threadLocals = null`ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒThreadLocalMapçš„ç±»å®šä¹‰åœ¨ThreadLocalä¸­ï¼Œä½†æ˜¯å…·ä½“çš„mapæ˜¯åœ¨Threadå¯¹è±¡ä¸­çš„ã€‚è¿™ä¸ªmapæ˜¯Threadå¯¹è±¡æŒæœ‰çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå«çº¿ç¨‹æœ¬åœ°å˜é‡äº†ï¼Œè¿™ä¸ªmapç›¸å½“äºæ˜¯è¿™ä¸ªçº¿ç¨‹ç§æœ‰çš„ä¸€å—ç¼“å­˜åŒºã€‚

#### getæ–¹æ³•

```java
public T get() {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    //å­˜åœ¨Mapå°±æ‰¾åˆ°å½“å‰çº¿ç¨‹Mapä¸­è¯¥ThreadLocalå¯¹è±¡çš„value
    if (map != null) {
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings("unchecked")
            T result = (T)e.value;
            return result;
        }
    }
    //æ²¡æœ‰å°±åˆå§‹åŒ–å®ƒ
    return setInitialValue();
}
```

#### removeæ–¹æ³•

```java
public void remove() {
    ThreadLocalMap m = getMap(Thread.currentThread());
    if (m != null)
        // å°±æ˜¯mapåˆ é™¤è¿™ä¸ªThreadLocalå¯¹è±¡ä¸ºkeyçš„å€¼
        m.remove(this);
}
```

getå’Œremoveæ–¹æ³•å°±å¾ˆç®€å•äº†ï¼Œå°±æ˜¯æ­£å¸¸çš„mapæ“ä½œã€‚æ‰€ä»¥ThreadLocalçš„é‡ç‚¹åœ¨äºè¿™ä¸ª`ThreadLocalMap`ã€‚

#### ThreadLocalMap

```java
static class ThreadLocalMap {
    static class Entry extends WeakReference<ThreadLocal<?>> {
        Object value;
        Entry(ThreadLocal<?> k, Object v) {
            super(k);
            value = v;
        }
    }
    private static final int INITIAL_CAPACITY = 16;
    private Entry[] table;
    private int size = 0;
    private int threshold; // Default to 0
    
    ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {}
    private ThreadLocalMap(ThreadLocalMap parentMap) {}
    
    private void set(ThreadLocal<?> key, Object value) {}
    private void remove(ThreadLocal<?> key) {}
    private static int nextIndex(int i, int len) {}
    private static int prevIndex(int i, int len) {}

	private void setThreshold(int len) {}
    private void rehash() {}
    private void resize() {}
}
```

è¿™ä¸ªMapçš„å…·ä½“æ–¹æ³•å®ç°ç»†èŠ‚ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œå¯ä»¥ç†è§£å°±æ˜¯åšäº†ä¸€ä¸ªå°å‹çš„HashMapã€‚ï¼ˆåé¢éƒ¨åˆ†è¯¦ç»†æ“ä½œåœ¨å†…å­˜æ³„æ¼é‡Œé¢è®²ï¼‰

#### å›¾è§£

 ![image-20210319235640529](D:\workspace\blog-docs\docs\Java-ThreadLocal\image-20210319235640529.png)


ä¸Šå›¾æè¿°Threadå’ŒThreadLocalä¹‹é—´çš„å…³ç³»ï¼Œä»æ­¤å°±èƒ½å¾—å‡ºå¾ˆå¤šåŸºç¡€ç»“è®ºäº†ï¼š

- çº¿ç¨‹å†…éƒ¨æŒæœ‰ä¸€ä¸ªMapå­˜æ”¾ç€è‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œè¿™äº›å˜é‡çš„keyæ˜¯ThreadLocalå¯¹è±¡ï¼ˆå¯ä»¥ç†è§£ä¸ºä»€ä¹ˆå«åšçº¿ç¨‹å±€éƒ¨å˜é‡äº†å§ï¼‰ï¼›
- æœ‰ä¸€ä¸ªå˜é‡æƒ³æ”¾å…¥çº¿ç¨‹çš„å±€éƒ¨å˜é‡çš„ä½ å°±éœ€è¦åˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡ï¼›
- ThreadLocalæœ¬èº«æ²¡æœ‰ä»€ä¹ˆå­˜å‚¨ç»“æ„ï¼Œåªæ˜¯æä¾›äº†æ–¹æ³•ï¼Œæ‰€ä»¥å˜é‡ä¸æ˜¯å­˜åœ¨ThreadLocalä¸­çš„ï¼ŒThreadLocalè´Ÿè´£æ¬è¿ã€‚

----



## å†…å­˜æ³„æ¼

ä¸€èˆ¬æ¥è¯´æœ‰GCçš„è¯­è¨€ä¸ä¼šå­˜åœ¨å†…å­˜æ³„æ¼çš„é—®é¢˜çš„ï¼Œæ‰€æœ‰çš„å¯¹è±¡é‡Šæ”¾çš„æ“ä½œéƒ½åº”è¯¥æ˜¯GCå»åšï¼Œä¸ç”¨æˆ‘ä»¬å»æ‰‹åŠ¨é‡Šæ”¾ã€‚ä½†æ˜¯ThreadLocalå› ä¸ºåº•å±‚å¯¹æˆ‘ä»¬çš„ä¸Šå±‚çš„ä¸€äº›ç»†èŠ‚å±è”½ï¼Œä¼šå¯¼è‡´GCæ— æ³•æ­£ç¡®çš„å›æ”¶å·²ç»ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚

### ä¸ºä»€ä¹ˆä¼šå†…å­˜æ³„æ¼ï¼Ÿ

æˆ‘ä»¬ä¸Šé¢å¾—çŸ¥Threadä¸­å­˜æ”¾äº†ä¸€ä¸ªThreadLocalMapï¼Œkeyæ˜¯ThreadLocalå¯¹è±¡ï¼Œvalueæ˜¯æˆ‘ä»¬éœ€è¦åé¢ä½¿ç”¨çš„å¯¹è±¡ï¼ˆè¿™é‡Œè¿˜æ˜¯ä¸¾ä¾‹XXï¼‰ã€‚

åœ¨ä¸€èˆ¬ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ªXXä½¿ç”¨å®Œäº†ï¼ŒGCä»Rootå‡ºå‘å»å‘ç°å¯è¾¾ï¼Œä¼šå‘ç°XXæ²¡æœ‰è¢«ä»»ä½•å¼•ç”¨ï¼Œæ­¤æ—¶å°±ä¼šå›æ”¶XXï¼Œè¿™æ˜¯æ²¡æœ‰ä½¿ç”¨ThreadLocalä¸‹çš„GCè¿‡ç¨‹ã€‚ä½†æ˜¯











### ä¸ºä»€ä¹ˆç”¨è™šå¼•ç”¨è€Œéå¼ºå¼•ç”¨

å…¶å®å°±ä¸€å¥è¯ï¼šå¼ºå¼•ç”¨ä¸€æ ·å†…å­˜æ³„éœ²ï¼







ä¸€äº›è¯¯åŒº

- ThreadLocalçš„å†…å­˜æ³„éœ²æ˜¯å› ä¸ºè™šå¼•ç”¨å¯¼è‡´çš„ã€‚
  - æ³„éœ²çš„æœ¬è´¨åŸå› æ˜¯ï¼šæˆ‘ä»¬ç¨‹åºä¸­è™½ç„¶ä¸å†å¼•ç”¨äº†ï¼Œä½†æ˜¯åœ¨ä½ ä¸çŸ¥é“çš„åœ°æ–¹ï¼ˆçº¿ç¨‹å¯¹è±¡å†…éƒ¨mapï¼‰ï¼Œå­˜åœ¨ç€å¼•ç”¨å…³ç³»ã€‚è€ŒThreadLocalçš„keyæ˜¯è™šå¼•ç”¨ï¼Œæ‰€ä»¥keyå¯ä»¥è¢«å›æ”¶ï¼Œä½†æ˜¯valueæ˜¯æ— æ³•è¢«å›æ”¶çš„ã€‚
  - å†…å­˜æ³„éœ²æ˜¯ThreadLocalè‡ªèº«åŸå› å¯¼è‡´çš„ï¼Œå’Œè™šå¼•ç”¨è¿˜æ˜¯å¼ºå¼•ç”¨æ²¡æœ‰å…³ç³»ã€‚è™šå¼•ç”¨åè€Œæ˜¯å‡å°‘äº†å†…å­˜æ³„éœ²çš„æ³„éœ²é‡ã€‚
  - å¦‚æœæœ¬ç€GCåº”è¯¥å¸®æˆ‘ä»¬åšåˆ°è¿™ç§åƒåœ¾å›æ”¶çš„å¿ƒæ€çš„è¯ï¼Œé‚£ä¹ˆå†…å­˜æ³„éœ²å’Œè™šå¼•ç”¨ä¹Ÿåªèƒ½æ‰¯ä¸Šä¸€ç‚¹ç‚¹å…³ç³»ã€‚ï¼ˆæˆ‘ä¸ç”¨äº†ä½ GCå°±åº”è¯¥å¸®æˆ‘å›æ”¶äº†å•Šï¼Œï¼‰æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæƒ³è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œé‚£ä¹ˆè¦ä¹ˆvalueä¹Ÿæ˜¯ç”¨è™šå¼•ç”¨ï¼ˆè¿™è‚¯å®šä¸è¡Œçš„ï¼‰ã€‚è¦ä¹ˆå°±æ˜¯çº¿ç¨‹è¦çŸ¥é“ä½ ä»€ä¹ˆæ—¶å€™è¿™ä¸ªå¯¹è±¡æ˜¯çœŸçš„ä¸ç”¨äº†ï¼Œç„¶åå¸®ä½ è¿›è¡Œremoveæ“ä½œï¼ˆè¿™å¥½åƒä¹Ÿæ²¡å¾—è¡Œçš„æ ·å­ï¼‰ã€‚





å¯¹äºJavaç¨‹åºå‘˜æ¥è¯´ï¼Œå¾ˆå°‘å…³æ³¨å¯¹è±¡çš„å›æ”¶ï¼Œæ‰€æœ‰å¯¹è±¡ä½¿ç”¨å®Œäº†éƒ½æ”¾å¿ƒçš„å…¨éƒ¨éƒ½äº¤ç»™åƒåœ¾å›æ”¶å™¨æ¥å¤„ç†ã€‚æˆ‘ä¸ªäººè§‰å¾—è¿™æ‰æ˜¯å¯¼è‡´å†…å­˜æ³„éœ²çš„ä¸»è¦åŸå›  ğŸ¶ã€‚ç„¶è€ŒThreadLocalè¿™ä¸€ç¥ç‰©ï¼Œå´åˆšå¥½é’»äº†ç©ºå­ã€‚æˆ‘ä»¬ç¨‹åºä¸­å¯èƒ½å·²ç»ä¸å†ä½¿ç”¨æŸä¸ªThreadLocalå¯¹è±¡äº†ï¼Œä½†æ˜¯çº¿ç¨‹ä¸­ä¼šä¸€ç›´æŒæœ‰è¯¥ThreadLocalçš„ç›¸å…³å¼•ç”¨ï¼ˆè™½ç„¶keyä¼šè¢«GCæˆåŠŸå›æ”¶ï¼‰ã€‚



> ç»¼ä¸Šï¼šä½¿ç”¨ThreadLocalä¸€å®šè¦æ³¨æ„ä¸€ç‚¹ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å®Œäº†çº¿ç¨‹æœ¬åœ°å¯¹è±¡åï¼Œä¸€å®šè¦è°ƒç”¨removeæ–¹æ³•ï¼ï¼ï¼æ¥é¿å…å†…å­˜æ³„æ¼ã€‚



https://www.jianshu.com/p/d225dde8c23c

https://blog.csdn.net/Y0Q2T57s/article/details/83247430



ç–‘é—®ï¼š æˆ‘ä»¬å®šä¹‰ThreadLocalå¯¹è±¡çš„æ—¶å€™ æ˜¯ä¸æ˜¯ä¸€å®šå®˜æ–¹demoé‚£æ ·å®šä¹‰æˆstaticçš„ï¼Ÿ åªè¦æˆ‘ä»¬ä¸å†æŒ‡å‘nullï¼ŒThreadLocalå¯¹è±¡å°± æ°¸è¿œéƒ½ä¸ä¼šè¢«å›æ”¶ï¼Ÿ

å¼±å¼•ç”¨åˆ°åº•å’Œå†…å­˜æ³„æ¼ æ˜¯å¦æœ‰å…³ï¼Ÿ







































